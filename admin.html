<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>Administration ici.c'est.PARIS</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-wrap {
            max-width: 800px;
            margin: 50px auto;
            padding: 40px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            border-top: 5px solid var(--paris-blue);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 800;
            margin-bottom: 8px;
            color: var(--paris-blue);
        }

        input,
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #EEE;
            border-radius: 10px;
            font-family: inherit;
        }

        .actions {
            display: flex;
            gap: 10px;
        }

        .btn-add {
            background: var(--paris-blue);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 900;
        }

        .btn-add:hover {
            background: var(--paris-red);
        }

        #auth-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--paris-blue);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #auth-modal {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>

<body>
    <div id="auth-screen">
        <div id="auth-modal">
            <h2 style="margin-bottom: 20px;">Acc√®s Boutique Officielle</h2>
            <input type="password" id="admin-pass" placeholder="Mot de passe">
            <button class="btn-add" style="margin-top: 15px;" onclick="checkAuth()">ENTRER</button>
        </div>
    </div>

    <div class="admin-wrap" id="admin-interface" style="display:none;">
        <h1 style="color:var(--paris-blue); margin-bottom: 30px;">Gestion ici.c'est.PARIS</h1>
        <div id="firebase-status" style="margin-bottom: 20px; padding: 15px; border-radius: 10px; font-weight: 700;">
            <span id="status-icon">‚è≥</span> <span id="status-text">V√©rification de la connexion Firebase...</span>
        </div>

        <div class="form-group">
            <label>Nom du Produit</label>
            <input type="text" id="p-name" placeholder="ex: Ensemble Nike Tech Green">
        </div>
        <div class="form-group">
            <label>Cat√©gorie</label>
            <select id="p-cat">
                <option value="Homme">Homme</option>
                <option value="Femme">Femme</option>
                <option value="Chaussures">Chaussures</option>
                <option value="Accessoires">Accessoires</option>
            </select>
        </div>
        <div class="form-group">
            <label>Taille(s) disponibles (s√©par√©es par des virgules)</label>
            <input type="text" id="p-sizes" placeholder="ex: S, M, L, XL ou 40, 41, 42">
        </div>
        <div class="form-group marathon-row" style="display:flex; gap:15px;">
            <div style="flex:1">
                <label>Prix (DA) *</label>
                <input type="number" id="p-price" placeholder="38500" min="0" step="1" required>
                <small id="price-preview" style="display:none; color:#666; font-size:12px; margin-top:5px;"></small>
            </div>
            <div style="flex:1">
                <label>Statut</label>
                <select id="p-stock">
                    <option value="in">En Stock</option>
                    <option value="out">Rupture</option>
                </select>
            </div>
        </div>
        <div class="form-group">
            <label>URL de l'image (Instagram ou Direct)</label>
            <input type="text" id="p-img" placeholder="https://...">
        </div>

        <button class="btn-add" onclick="addProduct()">PUBLIER SUR LA BOUTIQUE</button>

        <hr style="margin: 40px 0; border: 1px solid #EEE;">
        <h3>Aper√ßu du Flux Direct</h3>
        <p style="font-size: 13px; color: #666;">Les modifications appara√Ætront instantan√©ment sur le site d√®s que
            Firebase sera configur√©.</p>
    </div>

    <script>
        /**
         * Firebase Configuration for Admin Panel
         * 
         * IMPORTANT: Replace these placeholder values with your actual Firebase credentials
         * Get them from: Firebase Console > Project Settings > General > Your apps
         * 
         * Security Rules Required (Firebase Console > Realtime Database > Rules):
         * {
         *   "rules": {
         *     "products": {
         *       ".read": true,
         *       ".write": "auth != null || root.child('admin').child('enabled').val() == true"
         *     }
         *   }
         * }
         */
        const firebaseConfig = {
            apiKey: "AIzaSyAs-EXAMPLE-PLACEHOLDER",
            authDomain: "ici-cest-paris-store.firebaseapp.com",
            databaseURL: "https://ici-cest-paris-store-default-rtdb.firebaseio.com",
            projectId: "ici-cest-paris-store",
            storageBucket: "ici-cest-paris-store.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef"
        };
        
        let database;
        
        // Check if Firebase config is still using placeholder values
        const isPlaceholderConfig = firebaseConfig.apiKey.includes('EXAMPLE') || 
                                    firebaseConfig.apiKey === 'AIzaSyAs-EXAMPLE-PLACEHOLDER';
        
        if (isPlaceholderConfig) {
            console.warn("‚ö†Ô∏è Firebase config uses placeholder values!");
            console.log("üìù Please update firebaseConfig in admin.html with your actual Firebase credentials");
            
            // Show warning in UI
            setTimeout(() => {
                const adminWrap = document.getElementById('admin-interface');
                if (adminWrap) {
                    const warning = document.createElement('div');
                    warning.style.cssText = `
                        background: #fff3cd;
                        border: 2px solid #ffc107;
                        color: #856404;
                        padding: 15px;
                        border-radius: 10px;
                        margin-bottom: 20px;
                        font-weight: 700;
                    `;
                    warning.innerHTML = `
                        ‚ö†Ô∏è <strong>Firebase non configur√©!</strong><br>
                        Les produits ne seront pas sauvegard√©s en ligne tant que Firebase n'est pas configur√©.<br>
                        Consultez FIREBASE_SETUP.md pour les instructions.
                    `;
                    adminWrap.insertBefore(warning, adminWrap.firstChild);
                }
            }, 500);
        }
        
        try {
            if (typeof firebase !== 'undefined') {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                console.log("‚úÖ Firebase Admin initialized successfully");
                
                // Test connection
                database.ref('.info/connected').on('value', (snap) => {
                    if (snap.val() === true) {
                        console.log("‚úÖ Connected to Firebase");
                    } else {
                        console.warn("‚ö†Ô∏è Not connected to Firebase");
                    }
                });
            } else {
                console.error("‚ùå Firebase SDK not loaded");
                alert("‚ö†Ô∏è Firebase SDK non charg√©. V√©rifiez votre connexion internet.");
            }
        } catch (error) {
            console.error("‚ùå Firebase initialization error:", error);
            if (error.code === 'app/duplicate-app') {
                console.log("‚ÑπÔ∏è Firebase app already initialized");
                database = firebase.database();
            } else {
                alert("‚ö†Ô∏è Erreur d'initialisation Firebase: " + error.message);
            }
        }

        function checkAuth() {
            if (document.getElementById('admin-pass').value === 'paris2026') {
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('admin-interface').style.display = 'block';
            } else { alert("Mot de passe incorrect !"); }
        }

        // Format price with commas
        function formatPrice(price) {
            const numPrice = parseInt(price);
            if (isNaN(numPrice)) return price;
            return numPrice.toLocaleString('fr-FR');
        }
        
        // Update price preview
        function updatePricePreview() {
            const priceInput = document.getElementById('p-price');
            const preview = document.getElementById('price-preview');
            const price = priceInput.value.trim();
            
            if (price && !isNaN(price) && parseInt(price) > 0) {
                const formatted = formatPrice(price);
                preview.textContent = `Aper√ßu: ${formatted} DA`;
                preview.style.display = 'block';
                preview.style.color = '#28a745';
            } else if (price) {
                preview.textContent = '‚ö†Ô∏è Veuillez entrer un prix valide';
                preview.style.display = 'block';
                preview.style.color = '#dc3545';
            } else {
                preview.style.display = 'none';
            }
        }
        
        // Add event listener for price input
        document.addEventListener('DOMContentLoaded', () => {
            const priceInput = document.getElementById('p-price');
            if (priceInput) {
                priceInput.addEventListener('input', updatePricePreview);
                priceInput.addEventListener('blur', updatePricePreview);
            }
        });

        function addProduct() {
            // Validate inputs
            const name = document.getElementById('p-name').value.trim();
            const priceInput = document.getElementById('p-price');
            const price = priceInput.value.trim();
            const image = document.getElementById('p-img').value.trim();
            const sizes = document.getElementById('p-sizes').value.trim();
            
            if (!name || !price || !image) {
                alert("‚ö†Ô∏è Veuillez remplir tous les champs obligatoires (Nom, Prix, Image)");
                return;
            }
            
            // Validate price is a valid number
            const numPrice = parseInt(price);
            if (isNaN(numPrice) || numPrice <= 0) {
                alert("‚ö†Ô∏è Veuillez entrer un prix valide (nombre sup√©rieur √† 0)");
                priceInput.focus();
                return;
            }
            
            if (!database) {
                alert("‚ùå Firebase n'est pas configur√©. Veuillez configurer Firebase pour enregistrer en ligne.");
                return;
            }
            
            const id = Date.now();
            const formattedPrice = formatPrice(price);
            const product = {
                id: id,
                name: name,
                category: document.getElementById('p-cat').value,
                price: numPrice,
                displayPrice: formattedPrice + " DA",
                image: image,
                sizes: sizes ? sizes.split(',').map(s => s.trim()).filter(s => s) : ["Standard"],
                stock: document.getElementById('p-stock').value,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            // Show loading state
            const btn = document.querySelector('.btn-add');
            const originalText = btn.textContent;
            btn.textContent = "Publication en cours...";
            btn.disabled = true;

            database.ref('products/' + id).set(product)
                .then(() => {
                    console.log("‚úÖ Product saved to Firebase:", product);
                    alert("‚úÖ Produit ajout√© avec succ√®s !\n\nLe produit appara√Ætra sur le site dans quelques secondes.");
                    // Reset form
                    document.getElementById('p-name').value = '';
                    document.getElementById('p-price').value = '';
                    document.getElementById('p-img').value = '';
                    document.getElementById('p-sizes').value = '';
                    btn.textContent = originalText;
                    btn.disabled = false;
                    
                    // Verify the product was saved
                    setTimeout(() => {
                        database.ref('products/' + id).once('value', (snap) => {
                            if (snap.exists()) {
                                console.log("‚úÖ Verification: Product exists in Firebase");
                            } else {
                                console.warn("‚ö†Ô∏è Warning: Product not found after save");
                            }
                        });
                    }, 1000);
                })
                .catch(e => {
                    console.error("‚ùå Firebase error:", e);
                    let errorMsg = "‚ùå Erreur lors de l'ajout: " + e.message;
                    
                    // Check if it's a config issue
                    if (e.code === 'auth/configuration-not-found' || e.message.includes('API key')) {
                        errorMsg += "\n\n‚ö†Ô∏è V√©rifiez que votre configuration Firebase est correcte dans admin.html";
                    }
                    
                    alert(errorMsg);
                    btn.textContent = originalText;
                    btn.disabled = false;
                });
        }
        
        // Update Firebase status indicator
        function updateFirebaseStatus(connected, message) {
            const statusDiv = document.getElementById('firebase-status');
            const statusIcon = document.getElementById('status-icon');
            const statusText = document.getElementById('status-text');
            
            if (!statusDiv) return;
            
            if (connected) {
                statusDiv.style.background = '#d4edda';
                statusDiv.style.border = '2px solid #28a745';
                statusDiv.style.color = '#155724';
                statusIcon.textContent = '‚úÖ';
                statusText.textContent = message || 'Connect√© √† Firebase';
            } else {
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.border = '2px solid #dc3545';
                statusDiv.style.color = '#721c24';
                statusIcon.textContent = '‚ùå';
                statusText.textContent = message || 'Non connect√© √† Firebase';
            }
        }
        
        // Check Firebase connection status
        if (database) {
            database.ref('.info/connected').on('value', (snap) => {
                if (snap.val() === true) {
                    updateFirebaseStatus(true, '‚úÖ Connect√© √† Firebase - Les produits seront sauvegard√©s en ligne');
                } else {
                    updateFirebaseStatus(false, '‚ùå Non connect√© - V√©rifiez votre configuration Firebase');
                }
            });
            
            // Add real-time product preview
            database.ref('products').on('value', (snapshot) => {
                const products = snapshot.val();
                const count = products ? Object.keys(products).length : 0;
                const previewText = document.querySelector('.admin-wrap h3 + p');
                if (previewText) {
                    previewText.textContent = `Les modifications appara√Ætront instantan√©ment sur le site. ${count} produit(s) actuellement en ligne.`;
                }
            });
        } else {
            updateFirebaseStatus(false, '‚ùå Firebase non configur√© - Consultez FIREBASE_SETUP.md');
        }
    </script>
</body>

</html>